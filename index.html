<html>
  <head>
    <meta http-equiv="refresh" content="300">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//pshd.it/button.js"></script>
  </head>
  <body style="text-align:center;background-color:black;overflow:hidden">
    <div id="timer">
    </div>
    <div id="currentTime">
    </div>
    <div id="currentBTC">
    </div>
    <div id="dadstatus">
    </div>
    <script>
      const serverAddress = "http://192.168.1.33:8080";

      $("#dadstatus").css({
        position:"absolute",
        top: "50%",
        left: "35%",
        fontSize: 70,
        fontWeight: "bold",
        textDecoration: "blink",
        color: "white",
        zIndex: 10000
      });

      var button = pshdit.button('mattshome');
      button.on("pushed", function() { 
        var status = document.getElementById("dadstatus");
        status.innerHTML = 'Dad\'s Home!!!';
        
        var fade = setInterval(() => {
          $("#dadstatus").fadeToggle(1000);
        }, 1000);

        setTimeout(function() {
          status.innerHTML = "";
          clearInterval(fade);
        }, 30000);
      });

      function pad2(number) {
        var numStr = number + "";
        if (numStr.length < 2) {
          numStr = "0" + numStr;
        }

        return numStr;
      }   

      function dateStuff() {
        var offset= -8; //(Pacific Daylight Time)                                                                  
        // Check for DST
        var month = new Date().getMonth();
        var date = new Date().getDate();
        if (month > 2 && month < 10) {
          offset = -7;
        }
        else if (month == 2 && date >= 10) {
          offset = -7;
        }
        else if (month == 10 && date >= 4) {
          offset = -7;
        }
        var d = new Date( new Date().getTime() + offset * 3600 * 1000);
        return d;
      }

      function getImage() {
        $.get(serverAddress + "/rand", function(res) {
          console.log(res);
          var imgUrl = serverAddress + "/images/" + res;
          var imgExif = serverAddress + "/exif?file=" + res;

          var body = $(document.body);
          var img = $("<img class='slide' src='" + imgUrl +
                      "' style='display:none;position:absolute;top:0px;max-height:" + 
                      body.height() + ";max-width:" + body.width() + "'>");

          $.get(imgExif, (o) => {
            console.log("Orientation: " + o);
            var rotation = 0;
            switch(o) {
              case "8":
                rotation = -90;
                break;
              case "3":
                rotation = 180;
                break;
              case "6":
                rotation = 90;
                break;
            }

            console.log("Transforming: " + rotation);
            img.css({ WebkitTransform: 'rotate(' + rotation + 'deg)'});
            /*
            img.css({
              "transform": "rotate(" + rotation + "'deg')"
            });
            */
            console.log(img.attr("style"));
          });

          img.one("load", () => {
            var old = $(".slide");
            old.fadeOut({
                duration: 2000,
                queue:false,
                easing: "linear",
                done: () => {
                  old.remove();
                }
            });
        
            $(document.body).append(img.fadeIn({
              duration: 3000,
              easing: "linear",
              queue: false
            }).animate({
              left: body.width(),
            }, {
              duration: 30000,
              easing: "linear",
              queue:false
            }));
          });
        });
      }

      var timeLeft = 30;
      // Only do this when the computer boots.
      if (sessionStorage.firstLoad) {
        timeLeft = 0;
      }
      sessionStorage.firstLoad = true;

      var countDown = setInterval(() => {
        $("#timer").css({
          fontSize: 140,
          fontWeight: "bold",
          color: "white",
        }).text(timeLeft);
        timeLeft--;
      }, 1000);

      setTimeout(() => {
        clearInterval(timeLeft);
        $("#timer").remove();
        setInterval(getImage, 15000);
        getImage();
      }, timeLeft * 1000);

      setInterval(() => {
        var now = dateStuff();
        $("#currentTime").css({
          position:"absolute",
          bottom: 0,
          right: 20,
          fontSize: 70,
          fontWeight: "bold",
          color: "white",
          opacity: .5,
          zIndex: 1000
        }).text(((now.getHours()) % 12) + ":" + pad2(now.getMinutes()) + " " + (now.getMonth()+1) + "/" + now.getDate());
      }, 1000);

      setInterval(() => {
        $.get("https://theamackers.com/btc/account?op=price", (res) => {
          $("#currentBTC").css({
            position:"absolute",
            bottom: 0,
            left: 20,
            fontSize: 70,
            fontWeight: "bold",
            color: "white",
            opacity: .5,
            zIndex: 1000
          }).text(res);
        });
      }, 10000);

    </script>
  </body>
</html>
